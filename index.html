<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Work Force</title>

  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />

  <!-- PWA -->
  <link rel="manifest" href="/manifest.json" />
  <meta name="theme-color" content="#000000" />

  <!-- iOS standalone mode -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-title" content="Work Force" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

  <!-- iOS icon -->
  <link rel="apple-touch-icon" href="/icon-192.png" />

  <style>
    :root{
      --danger:#ff3b30;
      --ok:#34c759;
      --shadow:0 10px 30px rgba(0,0,0,.08);
      --radius:18px;
      --sheetShadow:0 30px 80px rgba(0,0,0,.25);
    }

    :root[data-theme="light"]{
      --bg:#f2f2f7;
      --card:#ffffff;
      --text:#111;
      --muted:rgba(17,17,17,.55);
      --line:rgba(17,17,17,.08);
      --btn:#111;
      --btnText:#fff;
      --pillBg:rgba(0,0,0,.06);
      --pillBorder:rgba(0,0,0,.06);
      --chipBg:#fff;
      --chipText:#111;
      --chipBorder:var(--line);
      --overlay:rgba(0,0,0,.35);
      --dockGlass:rgba(242,242,247,.82);
      --prioLowBg: rgba(0,0,0,.06);
      --prioLowText: rgba(0,0,0,.75);
      --prioMedBg: rgba(255,204,0,.16);
      --prioMedText: rgba(156,110,0,.95);
      --prioHighBg: rgba(255,59,48,.14);
      --prioHighText: rgba(255,59,48,.95);
    }

    :root[data-theme="dark"]{
      --bg:#0b0b0f;
      --card:#14141b;
      --text:#f5f5f7;
      --muted:rgba(245,245,247,.55);
      --line:rgba(245,245,247,.12);
      --btn:#f5f5f7;
      --btnText:#0b0b0f;
      --pillBg:rgba(245,245,247,.08);
      --pillBorder:rgba(245,245,247,.10);
      --chipBg:#14141b;
      --chipText:#f5f5f7;
      --chipBorder:rgba(245,245,247,.14);
      --overlay:rgba(0,0,0,.55);
      --dockGlass:rgba(10,10,14,.72);
      --prioLowBg: rgba(245,245,247,.08);
      --prioLowText: rgba(245,245,247,.85);
      --prioMedBg: rgba(255,204,0,.20);
      --prioMedText: rgba(255,216,77,.95);
      --prioHighBg: rgba(255,59,48,.20);
      --prioHighText: rgba(255,120,112,.95);
    }

    :root[data-theme="charcoal"]{
      --bg:#121214;
      --card:#1c1c1f;
      --text:#f2f2f4;
      --muted:rgba(242,242,244,.55);
      --line:rgba(242,242,244,.10);
      --btn:#f2f2f4;
      --btnText:#121214;
      --pillBg:rgba(242,242,244,.08);
      --pillBorder:rgba(242,242,244,.10);
      --chipBg:#1c1c1f;
      --chipText:#f2f2f4;
      --chipBorder:rgba(242,242,244,.14);
      --overlay:rgba(0,0,0,.55);
      --dockGlass:rgba(10,10,14,.72);
      --prioLowBg: rgba(242,242,244,.08);
      --prioLowText: rgba(242,242,244,.85);
      --prioMedBg: rgba(255,204,0,.20);
      --prioMedText: rgba(255,216,77,.95);
      --prioHighBg: rgba(255,59,48,.20);
      --prioHighText: rgba(255,120,112,.95);
    }

    :root[data-theme="ocean"]{
      --bg:#07131f;
      --card:#0f2237;
      --text:#eaf3ff;
      --muted:rgba(234,243,255,.55);
      --line:rgba(234,243,255,.12);
      --btn:#eaf3ff;
      --btnText:#07131f;
      --pillBg:rgba(234,243,255,.10);
      --pillBorder:rgba(234,243,255,.12);
      --chipBg:#0f2237;
      --chipText:#eaf3ff;
      --chipBorder:rgba(234,243,255,.16);
      --overlay:rgba(0,0,0,.55);
      --dockGlass:rgba(10,10,14,.72);
      --prioLowBg: rgba(234,243,255,.10);
      --prioLowText: rgba(234,243,255,.92);
      --prioMedBg: rgba(255,204,0,.20);
      --prioMedText: rgba(255,220,112,.95);
      --prioHighBg: rgba(255,59,48,.22);
      --prioHighText: rgba(255,140,132,.95);
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family:-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background:var(--bg);
      color:var(--text);
      -webkit-font-smoothing:antialiased;
      -webkit-text-size-adjust:100%;
      overscroll-behavior-y: none;
    }

    .app{
      max-width:820px;
      margin:0 auto;
      padding:18px 16px 122px;
    }

    header{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      margin:6px 0 14px;
    }

    .title{
      display:flex;
      flex-direction:column;
      gap:4px;
      min-width:0;
    }

    h1{
      margin:0;
      font-size:28px;
      letter-spacing:-0.02em;
    }

    .sub{
      margin:0;
      font-size:13px;
      color:var(--muted);
    }

    .row{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }

    .btn{
      border:none;
      border-radius:14px;
      padding:12px 14px;
      background:var(--btn);
      color:var(--btnText);
      font-weight:1000;
      cursor:pointer;
      transition:transform .05s ease;
      user-select:none;
      white-space:nowrap;
    }
    .btn:active{ transform:scale(.99); }

    .btn.secondary{
      background:transparent;
      color:var(--text);
      border:1px solid var(--line);
      font-weight:1000;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border-radius:999px;
      background:var(--pillBg);
      border:1px solid var(--pillBorder);
      font-size:12px;
      color:var(--text);
      white-space:nowrap;
    }

    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
    }

    .sectionHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:12px 14px;
      border-bottom:1px solid var(--line);
    }

    .sectionTitle{
      font-weight:1000;
      letter-spacing:-0.01em;
      display:flex;
      gap:10px;
      align-items:center;
    }

    .badge{
      font-size:12px;
      font-weight:1000;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid var(--line);
      color:var(--muted);
    }

    .composer{
      padding:14px;
      display:grid;
      gap:10px;
    }

    input, select, textarea, button{ font:inherit; }

    input[type="text"], input[type="datetime-local"], select, textarea{
      width:100%;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid var(--line);
      background:var(--card);
      color:var(--text);
      outline:none;
    }

    textarea{ resize:none; min-height:84px; }

    input:focus, select:focus, textarea:focus{
      border-color:rgba(127,127,127,.45);
    }

    .chip{
      border:1px solid var(--chipBorder);
      background:var(--chipBg);
      color:var(--chipText);
      border-radius:999px;
      padding:8px 10px;
      font-weight:1000;
      font-size:12px;
      cursor:pointer;
      user-select:none;
      white-space:nowrap;
    }
    .chip.on{
      background:var(--btn);
      color:var(--btnText);
      border-color:var(--btn);
    }

    .whenLabel{
      margin-left:auto;
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
    }

    .hint{
      font-size:12px;
      color:var(--muted);
      padding:10px 14px 0;
    }

    /* LIST + SWIPE */
    .list{ }

    .swipeWrap{
      position:relative;
      border-top:1px solid var(--line);
      overflow:hidden;
      background:var(--card);
    }
    .swipeWrap:first-child{ border-top:none; }

    .swipeBg{
      position:absolute;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:0 14px;
      font-weight:1000;
      user-select:none;
      pointer-events:none;
      letter-spacing:.01em;
    }
    .bgDone{ background:var(--ok); color:#fff; }
    .bgDel{ background:var(--danger); color:#fff; justify-content:flex-end; }

    .rowFront{
      position:relative;
      background:var(--card);
      padding:14px;
      display:flex;
      gap:12px;
      align-items:flex-start;
      justify-content:space-between;
      transform:translateX(0px);
      transition:transform .18s ease;
      will-change: transform;
      touch-action: pan-y;
    }
    .rowFront.dragging{ transition:none; }

    .left{
      display:flex;
      gap:12px;
      align-items:flex-start;
      min-width:0;
      flex:1;
    }

    .check{
      width:22px;
      height:22px;
      border-radius:7px;
      border:1.5px solid rgba(127,127,127,.5);
      flex:0 0 auto;
      margin-top:2px;
      display:grid;
      place-items:center;
      background:transparent;
      color:var(--text);
      cursor:pointer;
      user-select:none;
    }
    .check.on{
      background:var(--btn);
      border-color:var(--btn);
      color:var(--btnText);
    }

    .textWrap{ min-width:0; flex:1; }
    .task{
      margin:0;
      font-size:16px;
      line-height:1.2;
      word-break:break-word;
    }

    .meta{
      margin:8px 0 0;
      font-size:12px;
      color:var(--muted);
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }

    .pillMini{
      display:inline-flex;
      align-items:center;
      padding:4px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      font-size:11px;
      font-weight:1000;
      white-space:nowrap;
    }
    .pillMini.low{ background:var(--prioLowBg); color:var(--prioLowText); border-color:transparent; }
    .pillMini.medium{ background:var(--prioMedBg); color:var(--prioMedText); border-color:transparent; }
    .pillMini.high{ background:var(--prioHighBg); color:var(--prioHighText); border-color:transparent; }

    /* Animations */
    @keyframes popIn{
      from{ opacity:0; transform:translateY(10px); }
      to{ opacity:1; transform:translateY(0); }
    }
    .animateIn{ animation: popIn .18s ease both; }

    .fadeOut{
      opacity:0;
      transform:translateY(-6px);
      transition: opacity .18s ease, transform .18s ease;
    }

    /* Dock */
    .dock{
      position:fixed;
      left:0; right:0; bottom:0;
      padding:10px 12px calc(10px + env(safe-area-inset-bottom));
      background:var(--dockGlass);
      border-top:1px solid var(--line);
      backdrop-filter:saturate(180%) blur(18px);
    }
    .dockInner{
      max-width:820px;
      margin:0 auto;
      display:flex;
      gap:10px;
    }
    .dockInner .btn{ flex:1; }

    /* EDIT SHEET */
    .overlay{
      position:fixed;
      inset:0;
      background:var(--overlay);
      opacity:0;
      pointer-events:none;
      transition:opacity .18s ease;
    }
    .overlay.open{ opacity:1; pointer-events:auto; }

    .sheet{
      position:fixed;
      left:0; right:0; bottom:0;
      transform:translateY(110%);
      transition:transform .22s ease;
      padding:10px 12px calc(12px + env(safe-area-inset-bottom));
    }
    .sheet.open{ transform:translateY(0); }

    .sheetCard{
      max-width:820px;
      margin:0 auto;
      background:var(--card);
      border:1px solid var(--line);
      border-radius:22px;
      box-shadow:var(--sheetShadow);
      overflow:hidden;
    }

    .sheetTop{
      padding:12px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      border-bottom:1px solid var(--line);
    }
    .sheetTitle{ font-weight:1000; letter-spacing:-0.01em; }

    .sheetBody{ padding:14px; display:grid; gap:10px; }

    .sheetActions{
      padding:12px 14px;
      border-top:1px solid var(--line);
      display:flex;
      gap:10px;
    }
    .sheetActions .btn{ flex:1; }
    .dangerBtn{
      border:1px solid rgba(255,59,48,.25) !important;
      color:var(--danger) !important;
      background:transparent !important;
    }

    @media (max-width:420px){
      h1{ font-size:26px; }
      .whenLabel{ white-space:normal; }
    }
  </style>
</head>

<body>
  <div class="app">
    <header>
      <div class="title">
        <h1>Work Force</h1>
        <p class="sub">Schedule service calls. Set priority. Stay on top of it.</p>
      </div>

      <div class="row" style="justify-content:flex-end;">
        <button class="btn secondary" id="themeBtn" type="button">Theme</button>
        <div class="pill" id="statsPill">0 open ¬∑ 0 total</div>
      </div>
    </header>

    <div class="card">
      <div class="sectionHead">
        <div class="sectionTitle">Service Calls <span class="badge" id="countBadge">0</span></div>
        <button class="btn secondary" id="clearDoneBtn" type="button">Clear Done</button>
      </div>

      <div class="composer">
        <div class="row">
          <input id="custInput" type="text" placeholder="Customer / Company" autocomplete="off" />
        </div>

        <div class="row">
          <input id="addrInput" type="text" placeholder="Address / Location" />
        </div>

        <div class="row">
          <input id="whenInput" type="datetime-local" />
          <select id="prioInput" aria-label="Priority">
            <option value="low">Low</option>
            <option value="medium" selected>Medium</option>
            <option value="high">High</option>
          </select>
        </div>

        <div class="row" style="gap:8px;">
          <button class="chip" type="button" data-quick="none">No time</button>
          <button class="chip" type="button" data-quick="1h">In 1 hour</button>
          <button class="chip" type="button" data-quick="6pm">Today 6pm</button>
          <button class="chip" type="button" data-quick="tom9">Tomorrow 9am</button>
          <span class="whenLabel" id="whenLabel">No time set</span>
        </div>

        <div class="row">
          <textarea id="notesInput" placeholder="Notes (issue, parts needed, phone #, etc.)"></textarea>
        </div>

        <div class="row">
          <button class="btn" id="addBtn" type="button">Add Service Call</button>
        </div>

        <div class="hint">Swipe right to complete ‚úÖ ¬∑ swipe left to delete üóëÔ∏è ¬∑ tap a call to edit.</div>
      </div>

      <div class="list" id="list"></div>
    </div>
  </div>

  <div class="dock">
    <div class="dockInner">
      <button class="btn secondary" id="notifyBtn" type="button">Enable Notifications</button>
      <button class="btn" id="focusAddBtn" type="button">Quick Add</button>
    </div>
  </div>

  <!-- Edit Sheet -->
  <div class="overlay" id="overlay"></div>
  <div class="sheet" id="sheet">
    <div class="sheetCard">
      <div class="sheetTop">
        <div class="sheetTitle">Edit Service Call</div>
        <button class="btn secondary" id="closeSheetBtn" type="button">Close</button>
      </div>

      <div class="sheetBody">
        <input id="eCust" type="text" placeholder="Customer / Company" />
        <input id="eAddr" type="text" placeholder="Address / Location" />
        <div class="row">
          <input id="eWhen" type="datetime-local" />
          <select id="ePrio" aria-label="Priority">
            <option value="low">Low</option>
            <option value="medium">Medium</option>
            <option value="high">High</option>
          </select>
        </div>

        <div class="row" style="gap:8px;">
          <button class="chip" type="button" data-equick="none">No time</button>
          <button class="chip" type="button" data-equick="1h">In 1 hour</button>
          <button class="chip" type="button" data-equick="6pm">Today 6pm</button>
          <button class="chip" type="button" data-equick="tom9">Tomorrow 9am</button>
          <span class="whenLabel" id="eWhenLabel">No time set</span>
        </div>

        <textarea id="eNotes" placeholder="Notes"></textarea>
      </div>

      <div class="sheetActions">
        <button class="btn dangerBtn" id="deleteBtn" type="button">Delete</button>
        <button class="btn" id="saveBtn" type="button">Save</button>
      </div>
    </div>
  </div>

  <script>
    // ======================
    // Storage
    // ======================
    const STORE = {
      calls: "workforce_calls_v1",
      theme: "workforce_theme_v1"
    };

    function loadCalls(){
      try{ return JSON.parse(localStorage.getItem(STORE.calls) || "[]"); }
      catch(e){ return []; }
    }
    function saveCalls(items){
      localStorage.setItem(STORE.calls, JSON.stringify(items));
    }

    // ======================
    // State
    // ======================
    let calls = loadCalls();
    let lastCreatedId = null;
    let editingId = null;

    // ======================
    // Elements
    // ======================
    const themeBtn = document.getElementById("themeBtn");
    const statsPill = document.getElementById("statsPill");
    const countBadge = document.getElementById("countBadge");
    const clearDoneBtn = document.getElementById("clearDoneBtn");

    const custInput = document.getElementById("custInput");
    const addrInput = document.getElementById("addrInput");
    const whenInput = document.getElementById("whenInput");
    const prioInput = document.getElementById("prioInput");
    const notesInput = document.getElementById("notesInput");
    const addBtn = document.getElementById("addBtn");

    const listEl = document.getElementById("list");

    const whenLabel = document.getElementById("whenLabel");
    const quickChips = Array.from(document.querySelectorAll('.chip[data-quick]'));

    const notifyBtn = document.getElementById("notifyBtn");
    const focusAddBtn = document.getElementById("focusAddBtn");

    // sheet
    const overlay = document.getElementById("overlay");
    const sheet = document.getElementById("sheet");
    const closeSheetBtn = document.getElementById("closeSheetBtn");
    const deleteBtn = document.getElementById("deleteBtn");
    const saveBtn = document.getElementById("saveBtn");

    const eCust = document.getElementById("eCust");
    const eAddr = document.getElementById("eAddr");
    const eWhen = document.getElementById("eWhen");
    const ePrio = document.getElementById("ePrio");
    const eNotes = document.getElementById("eNotes");
    const eWhenLabel = document.getElementById("eWhenLabel");
    const eQuickChips = Array.from(document.querySelectorAll('.chip[data-equick]'));

    // ======================
    // Themes
    // ======================
    const themes = ["light","dark","charcoal","ocean"];

    function applyTheme(t){
      document.documentElement.setAttribute("data-theme", t);
      localStorage.setItem(STORE.theme, t);
    }
    function loadTheme(){
      const saved = localStorage.getItem(STORE.theme);
      if(saved && themes.includes(saved)) applyTheme(saved);
      else applyTheme("light");
    }
    function nextTheme(){
      const cur = document.documentElement.getAttribute("data-theme") || "light";
      const i = themes.indexOf(cur);
      applyTheme(themes[(i + 1) % themes.length]);
    }

    // ======================
    // Utilities
    // ======================
    function uid(){
      return (crypto.randomUUID ? crypto.randomUUID() : String(Date.now()) + Math.random().toString(16).slice(2));
    }

    function escapeHtml(str){
      return (str || "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function pad2(n){ return String(n).padStart(2,"0"); }

    function toDatetimeLocalValue(d){
      const yyyy = d.getFullYear();
      const mm = pad2(d.getMonth() + 1);
      const dd = pad2(d.getDate());
      const hh = pad2(d.getHours());
      const mi = pad2(d.getMinutes());
      return `${yyyy}-${mm}-${dd}T${hh}:${mi}`;
    }

    function isToday(d){
      const now = new Date();
      return d.getFullYear() === now.getFullYear() &&
             d.getMonth() === now.getMonth() &&
             d.getDate() === now.getDate();
    }

    function formatWhen(iso){
      if(!iso) return "No time set";
      const d = new Date(iso);
      if(Number.isNaN(d.getTime())) return "Invalid time";
      return d.toLocaleString([], { weekday:"short", month:"short", day:"numeric", hour:"numeric", minute:"2-digit" });
    }

    function updateStats(){
      const open = calls.filter(c => !c.done).length;
      const total = calls.length;
      statsPill.textContent = `${open} open ¬∑ ${total} total`;
      countBadge.textContent = String(total);
    }

    // ======================
    // Quick time (composer)
    // ======================
    function clearChipSelection(){
      quickChips.forEach(c => c.classList.remove("on"));
    }

    function setWhenLabelFromInput(){
      const v = (whenInput.value || "").trim();
      if(!v){ whenLabel.textContent = "No time set"; return; }
      const d = new Date(v);
      if(Number.isNaN(d.getTime())){ whenLabel.textContent = "Invalid time"; return; }
      const prefix = isToday(d) ? "Today" : "Scheduled";
      whenLabel.textContent = `${prefix}: ${d.toLocaleString([], { weekday:"short", month:"short", day:"numeric", hour:"numeric", minute:"2-digit" })}`;
    }

    function applyQuick(option){
      clearChipSelection();
      const chip = quickChips.find(c => c.dataset.quick === option);
      if(chip) chip.classList.add("on");

      if(option === "none"){
        whenInput.value = "";
        setWhenLabelFromInput();
        return;
      }

      const now = new Date();
      let d;

      if(option === "1h"){
        d = new Date(now.getTime() + 60*60*1000);
      } else if(option === "6pm"){
        d = new Date(now);
        d.setHours(18, 0, 0, 0);
        if(d.getTime() <= now.getTime()) d.setDate(d.getDate() + 1);
      } else if(option === "tom9"){
        d = new Date(now);
        d.setDate(d.getDate() + 1);
        d.setHours(9, 0, 0, 0);
      } else {
        return;
      }

      whenInput.value = toDatetimeLocalValue(d);
      setWhenLabelFromInput();
    }

    // ======================
    // Quick time (edit sheet)
    // ======================
    function clearEditChipSelection(){
      eQuickChips.forEach(c => c.classList.remove("on"));
    }

    function setEditWhenLabel(){
      const v = (eWhen.value || "").trim();
      if(!v){ eWhenLabel.textContent = "No time set"; return; }
      const d = new Date(v);
      if(Number.isNaN(d.getTime())){ eWhenLabel.textContent = "Invalid time"; return; }
      const prefix = isToday(d) ? "Today" : "Scheduled";
      eWhenLabel.textContent = `${prefix}: ${d.toLocaleString([], { weekday:"short", month:"short", day:"numeric", hour:"numeric", minute:"2-digit" })}`;
    }

    function applyEditQuick(option){
      clearEditChipSelection();
      const chip = eQuickChips.find(c => c.dataset.equick === option);
      if(chip) chip.classList.add("on");

      if(option === "none"){
        eWhen.value = "";
        setEditWhenLabel();
        return;
      }

      const now = new Date();
      let d;

      if(option === "1h"){
        d = new Date(now.getTime() + 60*60*1000);
      } else if(option === "6pm"){
        d = new Date(now);
        d.setHours(18, 0, 0, 0);
        if(d.getTime() <= now.getTime()) d.setDate(d.getDate() + 1);
      } else if(option === "tom9"){
        d = new Date(now);
        d.setDate(d.getDate() + 1);
        d.setHours(9, 0, 0, 0);
      } else {
        return;
      }

      eWhen.value = toDatetimeLocalValue(d);
      setEditWhenLabel();
    }

    // ======================
    // Animations
    // ======================
    function animateRemoveById(id){
      const wrap = listEl.querySelector(`[data-id="${CSS.escape(id)}"]`);
      if(!wrap) return;
      wrap.classList.add("fadeOut");
      setTimeout(() => { try{ wrap.remove(); }catch(e){} }, 200);
    }

    // ======================
    // Swipe
    // ======================
    function setupSwipe(rowFrontEl, onRight, onLeft){
      let startX=0, startY=0, dx=0, dragging=false, locked=false;
      const THRESH = 88;
      const MAX = 140;

      function setX(x){ rowFrontEl.style.transform = `translateX(${x}px)`; }

      function onStart(e){
        if(locked) return;
        const pt = (e.touches && e.touches[0]) ? e.touches[0] : e;
        startX = pt.clientX;
        startY = pt.clientY;
        dx = 0;
        dragging = false;
        rowFrontEl.classList.add("dragging");
      }

      function onMove(e){
        if(locked) return;
        const pt = (e.touches && e.touches[0]) ? e.touches[0] : e;
        const mx = pt.clientX - startX;
        const my = pt.clientY - startY;

        if(!dragging){
          if(Math.abs(my) > Math.abs(mx) && Math.abs(my) > 6){
            rowFrontEl.classList.remove("dragging");
            return;
          }
          if(Math.abs(mx) > 8){
            dragging = true;
          } else {
            return;
          }
        }

        e.preventDefault();
        dx = Math.max(-MAX, Math.min(MAX, mx));
        setX(dx);
      }

      function onEnd(){
        rowFrontEl.classList.remove("dragging");

        if(Math.abs(dx) < THRESH){
          rowFrontEl.style.transition = "transform .18s ease";
          setX(0);
          rowFrontEl.style.transition = "";
          dx = 0;
          return;
        }

        locked = true;
        rowFrontEl.style.transition = "transform .18s ease";

        if(dx > 0){
          setX(MAX);
          setTimeout(() => { try{ onRight(); }catch(e){} locked=false; }, 120);
        } else {
          setX(-MAX);
          setTimeout(() => { try{ onLeft(); }catch(e){} locked=false; }, 140);
        }
      }

      rowFrontEl.addEventListener("touchstart", onStart, { passive:true });
      rowFrontEl.addEventListener("touchmove", onMove, { passive:false });
      rowFrontEl.addEventListener("touchend", onEnd, { passive:true });
      rowFrontEl.addEventListener("touchcancel", onEnd, { passive:true });
    }

    // ======================
    // CRUD
    // ======================
    function addCall(){
      const cust = custInput.value.trim();
      const addr = addrInput.value.trim();
      const when = (whenInput.value || "").trim();
      const prio = prioInput.value;
      const notes = notesInput.value.trim();

      if(!cust){
        alert("Add a Customer / Company.");
        return;
      }

      const item = {
        id: uid(),
        customer: cust,
        address: addr,
        when,
        priority: prio,
        notes,
        done: false,
        created: Date.now()
      };

      calls.unshift(item);
      lastCreatedId = item.id;
      saveCalls(calls);

      custInput.value = "";
      addrInput.value = "";
      whenInput.value = "";
      prioInput.value = "medium";
      notesInput.value = "";
      clearChipSelection();
      setWhenLabelFromInput();
      custInput.focus();

      render();
      scheduleInAppNotification(item);
    }

    function toggleDone(id){
      const item = calls.find(c => c.id === id);
      if(!item) return;
      item.done = !item.done;
      saveCalls(calls);
      render();
    }

    function deleteCall(id){
      calls = calls.filter(c => c.id !== id);
      saveCalls(calls);
      animateRemoveById(id);
      setTimeout(render, 210);
    }

    function clearDone(){
      const doneIds = calls.filter(c => c.done).map(c => c.id);
      calls = calls.filter(c => !c.done);
      saveCalls(calls);
      doneIds.forEach(id => animateRemoveById(id));
      setTimeout(render, 220);
    }

    // ======================
    // Edit Sheet
    // ======================
    function openSheetFor(id){
      const item = calls.find(c => c.id === id);
      if(!item) return;

      editingId = id;

      eCust.value = item.customer || "";
      eAddr.value = item.address || "";
      eWhen.value = item.when || "";
      ePrio.value = item.priority || "medium";
      eNotes.value = item.notes || "";

      clearEditChipSelection();
      setEditWhenLabel();

      overlay.classList.add("open");
      sheet.classList.add("open");

      setTimeout(() => eCust.focus(), 60);
    }

    function closeSheet(){
      editingId = null;
      overlay.classList.remove("open");
      sheet.classList.remove("open");
    }

    function saveEdit(){
      if(!editingId) return;
      const item = calls.find(c => c.id === editingId);
      if(!item) return;

      const cust = eCust.value.trim();
      if(!cust){
        alert("Customer / Company can‚Äôt be empty.");
        return;
      }

      item.customer = cust;
      item.address = eAddr.value.trim();
      item.when = (eWhen.value || "").trim();
      item.priority = ePrio.value;
      item.notes = eNotes.value.trim();

      saveCalls(calls);
      closeSheet();
      render();
    }

    function deleteFromSheet(){
      if(!editingId) return;
      const id = editingId;
      closeSheet();
      deleteCall(id);
    }

    // ======================
    // Notifications (in-app only)
    // ======================
    async function enableNotifications(){
      if(!("Notification" in window)){
        alert("Notifications aren‚Äôt supported here.");
        return;
      }
      const perm = await Notification.requestPermission();
      if(perm !== "granted"){
        alert("Notifications not enabled.");
        return;
      }
      alert("Notifications enabled ‚úÖ\n\nNote: these fire while Work Force is open. True push while closed is possible, but takes more setup.");
    }

    function scheduleInAppNotification(call){
      if(!call.when) return;
      if(!("Notification" in window)) return;
      if(Notification.permission !== "granted") return;

      const ms = new Date(call.when).getTime() - Date.now();
      if(!Number.isFinite(ms) || ms <= 0) return;

      setTimeout(() => {
        try{ new Notification("Work Force Service Call", { body: call.customer }); }catch(e){}
      }, ms);
    }

    // ======================
    // Render
    // ======================
    function render(){
      listEl.innerHTML = "";

      if(calls.length === 0){
        const empty = document.createElement("div");
        empty.className = "swipeWrap";
        empty.innerHTML = `
          <div class="rowFront">
            <div class="left">
              <div class="textWrap">
                <p class="task" style="color:var(--muted);">No service calls yet. Add one above üëÜ</p>
                <p class="meta">Tip: set a priority and a time. Swipe right to complete.</p>
              </div>
            </div>
          </div>
        `;
        listEl.appendChild(empty);
        updateStats();
        return;
      }

      const sorted = calls
        .slice()
        .sort((a,b) => {
          if(a.done !== b.done) return a.done ? 1 : -1;

          // priority sort: high first, then medium, then low
          const pr = { high: 0, medium: 1, low: 2 };
          const pa = pr[a.priority] ?? 1;
          const pb = pr[b.priority] ?? 1;
          if(pa !== pb) return pa - pb;

          // then by time (if set), then newest
          const ta = a.when ? new Date(a.when).getTime() : Infinity;
          const tb = b.when ? new Date(b.when).getTime() : Infinity;
          if(ta !== tb) return ta - tb;

          return b.created - a.created;
        });

      sorted.forEach(call => {
        const wrap = document.createElement("div");
        wrap.className = "swipeWrap";
        wrap.dataset.id = call.id;

        const prioLabel = (call.priority || "medium").toLowerCase();
        const prioText = prioLabel === "high" ? "High" : prioLabel === "low" ? "Low" : "Medium";

        const metaBits = [];
        if(call.address) metaBits.push(`<span>${escapeHtml(call.address)}</span>`);
        metaBits.push(`<span>${escapeHtml(formatWhen(call.when))}</span>`);
        metaBits.push(`<span class="pillMini ${prioLabel}">${prioText} Priority</span>`);
        if(call.done) metaBits.push(`<span>Done</span>`);

        wrap.innerHTML = `
          <div class="swipeBg bgDone"><div>Done</div><div></div></div>
          <div class="swipeBg bgDel"><div>Delete</div></div>

          <div class="rowFront ${call.id === lastCreatedId ? "animateIn" : ""}">
            <div class="left">
              <button class="check ${call.done ? "on" : ""}" aria-label="Toggle done" type="button">
                ${call.done ? "‚úì" : ""}
              </button>
              <div class="textWrap">
                <p class="task" style="${call.done ? "text-decoration:line-through; color:var(--muted);" : ""}">
                  ${escapeHtml(call.customer)}
                </p>
                <p class="meta">${metaBits.join("")}</p>
                ${call.notes ? `<p class="meta" style="margin-top:6px;">${escapeHtml(call.notes)}</p>` : ""}
              </div>
            </div>
          </div>
        `;

        const rowFront = wrap.querySelector(".rowFront");
        const checkBtn = wrap.querySelector(".check");

        // tap to edit (except check)
        rowFront.addEventListener("click", (e) => {
          if(e.target === checkBtn) return;
          openSheetFor(call.id);
        });

        checkBtn.addEventListener("click", (e) => {
          e.stopPropagation();
          toggleDone(call.id);
        });

        setupSwipe(rowFront, () => toggleDone(call.id), () => deleteCall(call.id));

        listEl.appendChild(wrap);
      });

      lastCreatedId = null;
      updateStats();
    }

    // ======================
    // Events
    // ======================
    themeBtn.addEventListener("click", nextTheme);
    addBtn.addEventListener("click", addCall);

    custInput.addEventListener("keydown", (e) => {
      if(e.key === "Enter") addCall();
    });

    clearDoneBtn.addEventListener("click", clearDone);

    whenInput.addEventListener("change", () => {
      clearChipSelection();
      setWhenLabelFromInput();
    });

    quickChips.forEach(chip => {
      chip.addEventListener("click", () => applyQuick(chip.dataset.quick));
    });

    notifyBtn.addEventListener("click", enableNotifications);

    focusAddBtn.addEventListener("click", () => {
      custInput.focus();
      custInput.scrollIntoView({ behavior:"smooth", block:"center" });
    });

    // sheet events
    overlay.addEventListener("click", closeSheet);
    closeSheetBtn.addEventListener("click", closeSheet);
    saveBtn.addEventListener("click", saveEdit);
    deleteBtn.addEventListener("click", deleteFromSheet);

    eWhen.addEventListener("change", () => {
      clearEditChipSelection();
      setEditWhenLabel();
    });

    eQuickChips.forEach(chip => {
      chip.addEventListener("click", () => applyEditQuick(chip.dataset.equick));
    });

    document.addEventListener("keydown", (e) => {
      if(e.key === "Escape" && sheet.classList.contains("open")) closeSheet();
    });

    // ======================
    // Boot
    // ======================
    loadTheme();
    render();
    setWhenLabelFromInput();
  </script>
</body>
</html>
