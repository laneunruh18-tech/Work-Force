<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Work Force</title>

  <!-- Helps Safari/iPad not cling to old HTML too hard -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <style>
    :root{
      --bg:#ffffff;
      --panel:#fafafa;
      --border:#e8e8e8;
      --text:#111;
      --muted:rgba(0,0,0,.6);
      --shadow:0 10px 24px rgba(0,0,0,.06);
      --radius:14px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
    }

    .app{
      height:100vh;
      display:flex;
      overflow:hidden;
    }

    /* Sidebar */
    .sidebar{
      width:300px;
      border-right:1px solid var(--border);
      padding:14px;
      background:var(--panel);
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .brand{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .brand h1{
      margin:0;
      font-size:18px;
      letter-spacing:.2px;
    }
    .btn{
      border:1px solid var(--border);
      background:#fff;
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      font-weight:600;
    }
    .btn:hover{filter:brightness(0.98)}
    .btn:active{transform:translateY(1px)}
    .btn.primary{
      background:#111;
      color:#fff;
      border-color:#111;
    }
    .folder-list{
      display:flex;
      flex-direction:column;
      gap:8px;
      overflow:auto;
      padding-right:6px;
    }
    .folder{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      padding:10px 12px;
      border:1px solid var(--border);
      border-radius:14px;
      background:#fff;
      cursor:pointer;
      user-select:none;
    }
    .folder.active{
      outline:2px solid rgba(0,0,0,.12);
      background:#fff;
    }
    .folder .left{
      display:flex;
      flex-direction:column;
      gap:2px;
      min-width:0;
    }
    .folder .name{
      font-weight:800;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .folder .count{
      font-size:12px;
      color:var(--muted);
    }
    .folder .menu{
      color:var(--muted);
      font-weight:900;
      padding:0 6px;
    }
    .hint{
      font-size:12px;
      color:var(--muted);
      line-height:1.4;
    }

    /* Main */
    .main{
      flex:1;
      display:flex;
      flex-direction:column;
      padding:16px;
      gap:12px;
      overflow:hidden;
    }
    .topbar{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:14px;
      padding:14px;
      border:1px solid var(--border);
      border-radius:var(--radius);
      background:#fff;
      box-shadow:var(--shadow);
    }
    .titleblock .title{
      font-size:22px;
      font-weight:900;
      margin:0;
    }
    .titleblock .subtitle{
      margin-top:4px;
      font-size:13px;
      color:var(--muted);
    }
    .actions{
      display:flex;
      gap:10px;
      align-items:center;
    }
    .search{
      width:280px;
      max-width:36vw;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--border);
      outline:none;
      font-weight:600;
    }

    /* Calls list */
    .listwrap{
      flex:1;
      overflow:auto;
      padding-right:6px;
    }
    .empty{
      color:var(--muted);
      padding:16px;
    }
    .call{
      display:grid;
      grid-template-columns: 130px 1.2fr 1fr 160px 170px 150px;
      gap:10px;
      align-items:center;
      padding:12px 14px;
      border:1px solid var(--border);
      border-radius:16px;
      background:#fff;
      margin-bottom:10px;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:5px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      font-size:12px;
      font-weight:800;
      width:max-content;
    }
    .muted{color:var(--muted)}
    .strong{font-weight:900}
    .nowrap{white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
    .links{
      display:flex;
      gap:10px;
      justify-content:flex-end;
      flex-wrap:wrap;
    }
    .link{
      cursor:pointer;
      text-decoration:underline;
      font-weight:800;
      color:#111;
    }
    .link:hover{opacity:.8}

    /* Small screens fallback (still desktop-first) */
    @media (max-width: 980px){
      .sidebar{width:260px}
      .call{grid-template-columns: 120px 1fr 1fr; grid-auto-rows:auto}
      .call .colhide{display:none}
      .search{display:none}
    }
  </style>
</head>

<body>
  <div class="app">
    <aside class="sidebar">
      <div class="brand">
        <h1>Work Force</h1>
        <button class="btn" id="btnNewFolder">+ Folder</button>
      </div>

      <div class="hint">
        ðŸ’¡ <b>PC tip:</b> Right-click a folder to rename/delete.<br/>
        New service calls automatically go into the folder youâ€™re viewing.
      </div>

      <div class="folder-list" id="folderList"></div>
    </aside>

    <main class="main">
      <div class="topbar">
        <div class="titleblock">
          <div class="title" id="activeFolderTitle">Folder</div>
          <div class="subtitle" id="activeFolderSubtitle">
            Add calls fast. Mark Complete to move into Completed automatically.
          </div>
        </div>

        <div class="actions">
          <input class="search" id="searchBox" placeholder="Search customer / location..." />
          <button class="btn primary" id="btnNewCall">+ New Service Call</button>
        </div>
      </div>

      <div class="listwrap" id="callList"></div>
    </main>
  </div>

  <script>
    /*****************************************************************
     * Work Force (PC-first) - Folders + Service Calls (LocalStorage)
     * - Custom folders (named by you)
     * - Each call belongs to ONE folder
     * - New call auto goes into ACTIVE folder
     * - Completing a call moves it to global Completed folder
     *****************************************************************/

    const STORAGE_KEY = "workforce_v1";

    const DEFAULT_STATE = {
      folders: [
        { id: "f_grain", name: "Grain" },
        { id: "f_irrig", name: "Irrigation" },
        { id: "f_completed", name: "Completed", locked: true }
      ],
      activeFolderId: "f_grain",
      calls: []
      // call shape:
      // { id, folderId, priority, customer, location, status, createdAt, updatedAt }
    };

    const $ = (id) => document.getElementById(id);

    let state = loadState();
    let searchText = "";

    function uid(prefix="id") {
      return `${prefix}_${Math.random().toString(16).slice(2)}_${Date.now()}`;
    }

    function loadState(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if(!raw) return structuredClone(DEFAULT_STATE);
        const parsed = JSON.parse(raw);

        // safety merge
        const merged = {
          ...structuredClone(DEFAULT_STATE),
          ...parsed,
          folders: Array.isArray(parsed.folders) && parsed.folders.length ? parsed.folders : structuredClone(DEFAULT_STATE.folders),
          calls: Array.isArray(parsed.calls) ? parsed.calls : []
        };

        // ensure Completed exists
        if(!merged.folders.find(f => f.id === "f_completed")){
          merged.folders.push({ id:"f_completed", name:"Completed", locked:true });
        }
        // keep Completed last
        merged.folders = merged.folders.filter(f => f.id !== "f_completed").concat(merged.folders.find(f => f.id === "f_completed"));
        // ensure active folder
        if(!merged.folders.find(f => f.id === merged.activeFolderId)){
          merged.activeFolderId = merged.folders[0]?.id || "f_completed";
        }

        return merged;
      }catch{
        return structuredClone(DEFAULT_STATE);
      }
    }

    function saveState(){
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    }

    function escapeHtml(str) {
      return String(str ?? "").replace(/[&<>"']/g, s => ({
        "&":"&amp;", "<":"&lt;", ">":"&gt;", '"':"&quot;", "'":"&#39;"
      }[s]));
    }

    function getFolder(folderId){
      return state.folders.find(f => f.id === folderId);
    }

    function folderCallCount(folderId){
      return state.calls.filter(c => c.folderId === folderId).length;
    }

    function priorityPill(priority){
      const p = priority || "Medium";
      const icon = p === "High" ? "ðŸ”´" : p === "Low" ? "ðŸŸ¢" : "ðŸŸ¡";
      return `<span class="pill">${icon} ${escapeHtml(p)}</span>`;
    }

    /** ---------------- RENDER ---------------- */
    function render(){
      renderFolders();
      renderCalls();
    }

    function renderFolders(){
      const list = $("folderList");
      list.innerHTML = "";

      state.folders.forEach(folder => {
        const row = document.createElement("div");
        row.className = "folder" + (folder.id === state.activeFolderId ? " active" : "");
        row.dataset.id = folder.id;

        row.innerHTML = `
          <div class="left">
            <div class="name">${escapeHtml(folder.name)}</div>
            <div class="count">${folderCallCount(folder.id)} calls</div>
          </div>
          <div class="menu">${folder.locked ? "" : "â‹¯"}</div>
        `;

        row.addEventListener("click", () => {
          state.activeFolderId = folder.id;
          saveState();
          render();
        });

        if (!folder.locked) {
          row.addEventListener("contextmenu", (e) => {
            e.preventDefault();
            folderContextMenu(folder.id);
          });
        }

        list.appendChild(row);
      });
    }

    function renderCalls(){
      const folder = getFolder(state.activeFolderId);
      $("activeFolderTitle").textContent = folder ? folder.name : "Folder";

      const list = $("callList");
      const q = searchText.trim().toLowerCase();

      let calls = state.calls
        .filter(c => c.folderId === state.activeFolderId)
        .filter(c => {
          if(!q) return true;
          return (c.customer || "").toLowerCase().includes(q) || (c.location || "").toLowerCase().includes(q);
        })
        .sort((a,b) => (b.updatedAt ?? b.createdAt) - (a.updatedAt ?? a.createdAt));

      if(calls.length === 0){
        list.innerHTML = `<div class="empty">No service calls here yet.</div>`;
        return;
      }

      list.innerHTML = "";
      calls.forEach(call => {
        const row = document.createElement("div");
        row.className = "call";

        row.innerHTML = `
          <div>${priorityPill(call.priority)}</div>

          <div class="nowrap">
            <div class="strong">${escapeHtml(call.customer || "Unnamed Customer")}</div>
            <div class="muted nowrap">${escapeHtml(call.location || "No location/notes")}</div>
          </div>

          <div class="muted nowrap colhide">${escapeHtml(call.status || "New")}</div>

          <div class="muted nowrap colhide">${new Date(call.createdAt).toLocaleString()}</div>

          <div class="muted nowrap colhide">${escapeHtml(folder?.name || "")}</div>

          <div class="links">
            <span class="link" data-action="move">Move</span>
            <span class="link" data-action="edit">Edit</span>
            <span class="link" data-action="complete">Complete</span>
          </div>
        `;

        row.querySelector('[data-action="edit"]').addEventListener("click", () => editCall(call.id));
        row.querySelector('[data-action="complete"]').addEventListener("click", () => completeCall(call.id));
        row.querySelector('[data-action="move"]').addEventListener("click", () => moveCall(call.id));

        list.appendChild(row);
      });
    }

    /** ---------------- FOLDERS ---------------- */
    function addFolder(){
      const name = prompt("Folder name? (Example: Grain, Irrigation)");
      if(!name) return;
      const clean = name.trim();
      if(!clean) return;

      // prevent duplicates by name (optional)
      if(state.folders.some(f => f.name.toLowerCase() === clean.toLowerCase())){
        alert("That folder name already exists.");
        return;
      }

      const id = uid("f");
      // insert before Completed (keep Completed last)
      const completed = state.folders.find(f => f.id === "f_completed");
      state.folders = state.folders.filter(f => f.id !== "f_completed");
      state.folders.push({ id, name: clean });
      state.folders.push(completed);

      state.activeFolderId = id;
      saveState();
      render();
    }

    function renameFolder(folderId){
      const folder = getFolder(folderId);
      if(!folder || folder.locked) return;

      const name = prompt("Rename folder:", folder.name);
      if(!name) return;
      const clean = name.trim();
      if(!clean) return;

      if(state.folders.some(f => f.id !== folderId && f.name.toLowerCase() === clean.toLowerCase())){
        alert("Another folder already has that name.");
        return;
      }

      folder.name = clean;
      saveState();
      render();
    }

    function deleteFolder(folderId){
      const folder = getFolder(folderId);
      if(!folder || folder.locked) return;

      const count = folderCallCount(folderId);
      const ok = confirm(`Delete folder "${folder.name}"?\n\n${count} calls will be moved to Completed.`);
      if(!ok) return;

      // move calls to Completed
      state.calls.forEach(c => {
        if(c.folderId === folderId) c.folderId = "f_completed";
      });

      state.folders = state.folders.filter(f => f.id !== folderId);

      if(state.activeFolderId === folderId) state.activeFolderId = "f_completed";

      saveState();
      render();
    }

    function folderContextMenu(folderId){
      const choice = prompt("Folder options:\n1 = Rename\n2 = Delete\n(Cancel to exit)");
      if(choice === "1") renameFolder(folderId);
      if(choice === "2") deleteFolder(folderId);
    }

    /** ---------------- CALLS ---------------- */
    function addCallInActiveFolder(){
      // If user is in Completed, we donâ€™t create new calls there
      const targetFolderId = (state.activeFolderId === "f_completed")
        ? (state.folders.find(f => f.id !== "f_completed")?.id || "f_completed")
        : state.activeFolderId;

      const customer = prompt("Customer name?");
      if(!customer) return;

      const location = prompt("Location / notes? (optional)") || "";
      const priority = (prompt("Priority? Type Low / Medium / High", "Medium") || "Medium").trim();

      const now = Date.now();
      state.calls.unshift({
        id: uid("c"),
        folderId: targetFolderId,
        customer: customer.trim(),
        location: location.trim(),
        priority: ["Low","Medium","High"].includes(priority) ? priority : "Medium",
        status: "New",
        createdAt: now,
        updatedAt: now
      });

      saveState();
      render();
    }

    function editCall(callId){
      const call = state.calls.find(c => c.id === callId);
      if(!call) return;

      const customer = prompt("Customer name:", call.customer) ?? call.customer;
      const location = prompt("Location / notes:", call.location) ?? call.location;
      const priority = prompt("Priority? Low / Medium / High", call.priority) ?? call.priority;
      const status = prompt("Status (New, Scheduled, Waiting Parts, In Progress, etc.)", call.status) ?? call.status;

      call.customer = String(customer).trim();
      call.location = String(location).trim();
      const p = String(priority).trim();
      call.priority = ["Low","Medium","High"].includes(p) ? p : call.priority;
      call.status = String(status).trim();
      call.updatedAt = Date.now();

      saveState();
      render();
    }

    function completeCall(callId){
      const call = state.calls.find(c => c.id === callId);
      if(!call) return;

      const ok = confirm(`Mark "${call.customer}" as completed?\nIt will move to Completed.`);
      if(!ok) return;

      call.status = "Completed";
      call.folderId = "f_completed";
      call.updatedAt = Date.now();

      saveState();
      render();
    }

    function moveCall(callId){
      const call = state.calls.find(c => c.id === callId);
      if(!call) return;

      const folderNames = state.folders
        .filter(f => f.id !== "f_completed")
        .map(f => f.name);

      const current = getFolder(call.folderId)?.name || "";
      const pick = prompt(
        `Move call to which folder?\n\nAvailable:\n- ${folderNames.join("\n- ")}\n\nCurrent: ${current}`
      );

      if(!pick) return;
      const clean = pick.trim().toLowerCase();

      const dest = state.folders.find(f => !f.locked && f.name.toLowerCase() === clean);
      if(!dest){
        alert("Folder not found. (Tip: type the folder name exactly.)");
        return;
      }

      call.folderId = dest.id;
      call.updatedAt = Date.now();
      saveState();
      render();
    }

    /** ---------------- WIRE UP ---------------- */
    $("btnNewFolder").addEventListener("click", addFolder);
    $("btnNewCall").addEventListener("click", addCallInActiveFolder);

    $("searchBox").addEventListener("input", (e) => {
      searchText = e.target.value || "";
      renderCalls();
    });

    // Nice PC shortcuts:
    // N = new call, / = focus search, Esc = clear search
    window.addEventListener("keydown", (e) => {
      if (e.target && (e.target.tagName === "INPUT" || e.target.tagName === "TEXTAREA")) return;

      if (e.key.toLowerCase() === "n") addCallInActiveFolder();
      if (e.key === "/") { e.preventDefault(); $("searchBox").focus(); }
      if (e.key === "Escape") { $("searchBox").value = ""; searchText = ""; renderCalls(); }
    });

    render();
  </script>
</body>
</html>
