<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Work Force</title>

  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <style>
    :root{
      --bg:#ffffff;
      --panel:#fafafa;
      --border:#e8e8e8;
      --text:#111;
      --muted:rgba(0,0,0,.6);
      --shadow:0 10px 24px rgba(0,0,0,.06);
      --radius:14px;

      --danger:#c62828;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
    }

    .app{
      height:100vh;
      display:flex;
      overflow:hidden;
      position:relative;
    }

    /* Sidebar */
    .sidebar{
      width:300px;
      border-right:1px solid var(--border);
      padding:14px;
      background:var(--panel);
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .brand{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .brand h1{
      margin:0;
      font-size:18px;
      letter-spacing:.2px;
    }
    .btn{
      border:1px solid var(--border);
      background:#fff;
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      font-weight:800;
    }
    .btn:hover{filter:brightness(0.98)}
    .btn:active{transform:translateY(1px)}
    .btn.primary{
      background:#111;
      color:#fff;
      border-color:#111;
    }
    .btn.danger{
      background:var(--danger);
      color:#fff;
      border-color:var(--danger);
    }
    .btn.ghost{
      background:#fff;
      border-color:var(--border);
      color:#111;
    }

    .hint{
      font-size:12px;
      color:var(--muted);
      line-height:1.45;
    }
    .kbd{
      display:inline-block;
      border:1px solid var(--border);
      border-bottom-width:2px;
      padding:2px 6px;
      border-radius:7px;
      background:#fff;
      font-weight:900;
      font-size:11px;
      color:rgba(0,0,0,.8);
      margin:0 2px;
    }

    .folder-list{
      display:flex;
      flex-direction:column;
      gap:8px;
      overflow:auto;
      padding-right:6px;
    }
    .folder{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      padding:10px 12px;
      border:1px solid var(--border);
      border-radius:14px;
      background:#fff;
      cursor:pointer;
      user-select:none;
    }
    .folder.active{
      outline:2px solid rgba(0,0,0,.12);
    }
    .folder .left{
      display:flex;
      flex-direction:column;
      gap:2px;
      min-width:0;
      flex:1;
    }
    .folder .name{
      font-weight:1000;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .folder .count{
      font-size:12px;
      color:var(--muted);
    }
    .iconbtn{
      border:1px solid var(--border);
      background:#fff;
      width:34px;
      height:34px;
      border-radius:12px;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      font-weight:1000;
      color:rgba(0,0,0,.65);
      flex:0 0 auto;
    }
    .iconbtn:hover{filter:brightness(0.98)}
    .iconbtn:active{transform:translateY(1px)}
    .iconbtn[disabled]{opacity:.45; cursor:not-allowed}

    /* Main */
    .main{
      flex:1;
      display:flex;
      flex-direction:column;
      padding:16px;
      gap:12px;
      overflow:hidden;
    }
    .topbar{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:14px;
      padding:14px;
      border:1px solid var(--border);
      border-radius:var(--radius);
      background:#fff;
      box-shadow:var(--shadow);
    }
    .titleblock .title{
      font-size:22px;
      font-weight:1100;
      margin:0;
    }
    .titleblock .subtitle{
      margin-top:4px;
      font-size:13px;
      color:var(--muted);
    }
    .actions{
      display:flex;
      gap:10px;
      align-items:center;
    }
    .search{
      width:320px;
      max-width:40vw;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--border);
      outline:none;
      font-weight:800;
    }

    /* Calls list */
    .listwrap{flex:1; overflow:auto; padding-right:6px;}
    .empty{color:var(--muted); padding:16px;}
    .call{
      display:grid;
      grid-template-columns: 140px 1.2fr 1fr 160px 160px 170px;
      gap:10px;
      align-items:center;
      padding:12px 14px;
      border:1px solid var(--border);
      border-radius:16px;
      background:#fff;
      margin-bottom:10px;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:5px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      font-size:12px;
      font-weight:1000;
      width:max-content;
    }
    .muted{color:var(--muted)}
    .strong{font-weight:1100}
    .nowrap{white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
    .links{display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap;}
    .link{
      cursor:pointer;
      text-decoration:underline;
      font-weight:1000;
      color:#111;
    }
    .link:hover{opacity:.8}
    .tag{font-size:12px; font-weight:1000; color:rgba(0,0,0,.8);}

    /* Backdrop + Drawer */
    .backdrop{
      position:absolute;
      inset:0;
      background:rgba(0,0,0,.25);
      opacity:0;
      pointer-events:none;
      transition:opacity .18s ease;
    }
    .backdrop.show{
      opacity:1;
      pointer-events:auto;
    }

    .drawer{
      position:absolute;
      top:0; right:0;
      height:100%;
      width:440px;
      max-width:92vw;
      background:#fff;
      border-left:1px solid var(--border);
      box-shadow:var(--shadow);
      transform:translateX(102%);
      transition:transform .22s ease;
      display:flex;
      flex-direction:column;
    }
    .drawer.show{transform:translateX(0)}
    .drawer-header{
      padding:14px;
      border-bottom:1px solid var(--border);
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
    }
    .drawer-title{font-size:18px; font-weight:1100; margin:0;}
    .drawer-subtitle{margin-top:4px; font-size:12px; color:var(--muted); line-height:1.35;}
    .drawer-body{
      padding:14px;
      overflow:auto;
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .drawer-footer{
      border-top:1px solid var(--border);
      padding:12px 14px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      background:#fff;
    }
    .drawer-footer .left, .drawer-footer .right{display:flex; gap:10px; align-items:center;}

    .grid{display:grid; grid-template-columns: 1fr 1fr; gap:10px;}
    .field{display:flex; flex-direction:column; gap:6px;}
    label{font-size:12px; font-weight:1000; color:rgba(0,0,0,.75);}
    input, select, textarea{
      border:1px solid var(--border);
      border-radius:12px;
      padding:10px 12px;
      font-weight:800;
      outline:none;
      font-family:inherit;
      font-size:14px;
      background:#fff;
    }
    textarea{min-height:92px; resize:vertical; font-weight:700;}
    .readonly{background:#f6f6f6; color:rgba(0,0,0,.75);}

    /* Folder modal (real form) */
    .modal{
      position:absolute;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      pointer-events:none;
    }
    .modal-card{
      width:520px;
      max-width:92vw;
      background:#fff;
      border:1px solid var(--border);
      border-radius:18px;
      box-shadow:var(--shadow);
      transform:translateY(10px);
      opacity:0;
      transition:opacity .18s ease, transform .18s ease;
      pointer-events:none;
    }
    .modal.show .modal-card{
      opacity:1;
      transform:translateY(0);
      pointer-events:auto;
    }
    .modal-header{
      padding:14px;
      border-bottom:1px solid var(--border);
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
    }
    .modal-title{font-size:16px; font-weight:1100; margin:0;}
    .modal-subtitle{margin-top:4px; font-size:12px; color:var(--muted); line-height:1.35;}
    .modal-body{padding:14px; display:flex; flex-direction:column; gap:12px;}
    .modal-footer{
      padding:12px 14px;
      border-top:1px solid var(--border);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
    }
    .helper{font-size:12px; color:var(--muted);}

    @media (max-width: 980px){
      .sidebar{width:260px}
      .call{grid-template-columns: 140px 1fr 1fr; grid-auto-rows:auto}
      .call .colhide{display:none}
      .search{display:none}
      .drawer{width:92vw}
    }
  </style>
</head>

<body>
  <div class="app">
    <aside class="sidebar">
      <div class="brand">
        <h1>Work Force</h1>
        <button class="btn" id="btnNewFolder">+ Folder</button>
      </div>

      <div class="hint">
        PC shortcuts:
        <span class="kbd">N</span> new call,
        <span class="kbd">/</span> search,
        <span class="kbd">Esc</span> close,
        <span class="kbd">Ctrl</span>+<span class="kbd">Enter</span> save.
      </div>

      <div class="folder-list" id="folderList"></div>
    </aside>

    <main class="main">
      <div class="topbar">
        <div class="titleblock">
          <div class="title" id="activeFolderTitle">Folder</div>
          <div class="subtitle" id="activeFolderSubtitle">
            New calls go into the open folder. Completed calls move out automatically.
          </div>
        </div>

        <div class="actions">
          <input class="search" id="searchBox" placeholder="Search customer / location / phone..." />
          <button class="btn primary" id="btnNewCall">+ New Service Call</button>
        </div>
      </div>

      <div class="listwrap" id="callList"></div>
    </main>

    <!-- Backdrop shared by drawer + modal -->
    <div class="backdrop" id="backdrop" aria-hidden="true"></div>

    <!-- Folder Modal (real form) -->
    <div class="modal" id="folderModal" aria-hidden="true">
      <div class="modal-card">
        <div class="modal-header">
          <div>
            <div class="modal-title" id="folderModalTitle">New Folder</div>
            <div class="modal-subtitle" id="folderModalSubtitle">Create a department like Grain, Irrigation, etc.</div>
          </div>
          <button class="btn ghost" id="btnCloseFolderModal">Close</button>
        </div>

        <div class="modal-body">
          <div class="field">
            <label for="fm_name">Folder Name *</label>
            <input id="fm_name" autocomplete="off" placeholder="Grain" />
          </div>
          <div class="helper" id="folderModalHelper">
            Tip: Keep folder names short and consistent. Example: Grain, Irrigation, Service.
          </div>
        </div>

        <div class="modal-footer">
          <div class="left">
            <button class="btn danger" id="btnDeleteFolder" style="display:none;">Delete Folder</button>
          </div>
          <div class="right" style="display:flex; gap:10px;">
            <button class="btn" id="btnCancelFolderModal">Cancel</button>
            <button class="btn primary" id="btnSaveFolderModal">Save</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Service Call Drawer -->
    <section class="drawer" id="drawer" aria-hidden="true">
      <div class="drawer-header">
        <div>
          <div class="drawer-title" id="drawerTitle">New Service Call</div>
          <div class="drawer-subtitle" id="drawerSubtitle">Folder auto-selects from the left sidebar.</div>
        </div>
        <button class="btn ghost" id="btnCloseDrawer">Close</button>
      </div>

      <div class="drawer-body">
        <div class="field">
          <label for="f_customer">Customer Name *</label>
          <input id="f_customer" autocomplete="off" placeholder="Smith Farm" />
        </div>

        <div class="grid">
          <div class="field">
            <label for="f_phone">Phone</label>
            <input id="f_phone" autocomplete="off" placeholder="(555) 555-5555" />
          </div>
          <div class="field">
            <label for="f_tech">Technician</label>
            <input id="f_tech" autocomplete="off" placeholder="Jake" />
          </div>
        </div>

        <div class="field">
          <label for="f_location">Location / Machine / Notes (short)</label>
          <input id="f_location" autocomplete="off" placeholder="West bin site, dryer #2, etc." />
        </div>

        <div class="grid">
          <div class="field">
            <label for="f_folder">Folder</label>
            <input id="f_folder" class="readonly" readonly />
          </div>
          <div class="field">
            <label for="f_scheduled">Scheduled Date/Time</label>
            <input id="f_scheduled" type="datetime-local" />
          </div>
        </div>

        <div class="grid">
          <div class="field">
            <label for="f_priority">Priority</label>
            <select id="f_priority">
              <option>Low</option>
              <option selected>Medium</option>
              <option>High</option>
            </select>
          </div>
          <div class="field">
            <label for="f_status">Status</label>
            <select id="f_status">
              <option selected>New</option>
              <option>Scheduled</option>
              <option>In Progress</option>
              <option>Waiting on Parts</option>
              <option>Waiting on Customer</option>
              <option>Completed</option>
            </select>
          </div>
        </div>

        <div class="field">
          <label for="f_details">Details / Full Notes</label>
          <textarea id="f_details" placeholder="Write the full issue, parts needed, what customer said, etc."></textarea>
        </div>

        <div class="helper">
          Tip: Use <b>Tab</b> to move field-to-field. Use <b>Ctrl + Enter</b> to save.
        </div>
      </div>

      <div class="drawer-footer">
        <div class="left">
          <button class="btn danger" id="btnDeleteCall" style="display:none;">Delete</button>
        </div>
        <div class="right">
          <button class="btn" id="btnCancel">Cancel</button>
          <button class="btn primary" id="btnSave">Save</button>
        </div>
      </div>
    </section>
  </div>

  <script>
    /*****************************************************************
     * Work Force (PC-first)
     * - Real folder modal (create/rename/delete)
     * - Real service call drawer (new/edit)
     *****************************************************************/
    const STORAGE_KEY = "workforce_v3";

    const DEFAULT_STATE = {
      folders: [
        { id: "f_grain", name: "Grain" },
        { id: "f_irrig", name: "Irrigation" },
        { id: "f_completed", name: "Completed", locked: true }
      ],
      activeFolderId: "f_grain",
      calls: []
      // call:
      // { id, folderId, customer, phone, tech, location, details, priority, status, scheduledAt, createdAt, updatedAt }
    };

    const $ = (id) => document.getElementById(id);

    let state = loadState();
    let searchText = "";

    // Drawer state
    let drawerMode = "new"; // "new" | "edit"
    let editingCallId = null;

    // Folder modal state
    let folderModalMode = "new"; // "new" | "rename"
    let editingFolderId = null;

    function uid(prefix="id") {
      return `${prefix}_${Math.random().toString(16).slice(2)}_${Date.now()}`;
    }

    function loadState(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if(!raw) return structuredClone(DEFAULT_STATE);
        const parsed = JSON.parse(raw);

        const merged = {
          ...structuredClone(DEFAULT_STATE),
          ...parsed,
          folders: Array.isArray(parsed.folders) && parsed.folders.length ? parsed.folders : structuredClone(DEFAULT_STATE.folders),
          calls: Array.isArray(parsed.calls) ? parsed.calls : []
        };

        // ensure Completed exists + last
        if(!merged.folders.find(f => f.id === "f_completed")){
          merged.folders.push({ id:"f_completed", name:"Completed", locked:true });
        }
        const completed = merged.folders.find(f => f.id === "f_completed");
        merged.folders = merged.folders.filter(f => f.id !== "f_completed").concat(completed);

        if(!merged.folders.find(f => f.id === merged.activeFolderId)){
          merged.activeFolderId = merged.folders[0]?.id || "f_completed";
        }

        return merged;
      }catch{
        return structuredClone(DEFAULT_STATE);
      }
    }

    function saveState(){
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    }

    function escapeHtml(str) {
      return String(str ?? "").replace(/[&<>"']/g, s => ({
        "&":"&amp;", "<":"&lt;", ">":"&gt;", '"':"&quot;", "'":"&#39;"
      }[s]));
    }

    function getFolder(folderId){
      return state.folders.find(f => f.id === folderId);
    }

    function folderCallCount(folderId){
      return state.calls.filter(c => c.folderId === folderId).length;
    }

    function normalizePhone(phone){
      return String(phone || "").trim().replace(/[^0-9+]/g, "");
    }

    function priorityPill(priority){
      const p = priority || "Medium";
      const icon = p === "High" ? "ðŸ”´" : p === "Low" ? "ðŸŸ¢" : "ðŸŸ¡";
      return `<span class="pill">${icon} ${escapeHtml(p)}</span>`;
    }

    function statusTag(status){
      const s = status || "New";
      return `<span class="tag">${escapeHtml(s)}</span>`;
    }

    function fmtWhen(ts){
      if(!ts) return "";
      const d = new Date(ts);
      if(Number.isNaN(d.getTime())) return "";
      return d.toLocaleString();
    }

    /** ---------------- Overlay control ---------------- */
    function anyOverlayOpen(){
      return $("drawer").classList.contains("show") || $("folderModal").classList.contains("show");
    }

    function showBackdrop(){
      $("backdrop").classList.add("show");
      $("backdrop").setAttribute("aria-hidden", "false");
    }
    function hideBackdropIfNone(){
      if(!anyOverlayOpen()){
        $("backdrop").classList.remove("show");
        $("backdrop").setAttribute("aria-hidden", "true");
      }
    }

    /** ---------------- Render ---------------- */
    function render(){
      renderFolders();
      renderCalls();
    }

    function renderFolders(){
      const list = $("folderList");
      list.innerHTML = "";

      state.folders.forEach(folder => {
        const row = document.createElement("div");
        row.className = "folder" + (folder.id === state.activeFolderId ? " active" : "");
        row.dataset.id = folder.id;

        const menuDisabled = !!folder.locked;

        row.innerHTML = `
          <div class="left">
            <div class="name">${escapeHtml(folder.name)}</div>
            <div class="count">${folderCallCount(folder.id)} calls</div>
          </div>
          <button class="iconbtn" ${menuDisabled ? "disabled" : ""} title="Folder options">â‹¯</button>
        `;

        // click folder selects it
        row.addEventListener("click", () => {
          state.activeFolderId = folder.id;
          saveState();
          render();
          // if drawer open and in "new", keep folder label correct
          if($("drawer").classList.contains("show") && drawerMode === "new") setDrawerHeader();
        });

        // menu button opens folder modal (rename/delete)
        const menuBtn = row.querySelector(".iconbtn");
        menuBtn.addEventListener("click", (e) => {
          e.stopPropagation();
          if(folder.locked) return;
          openFolderModalRename(folder.id);
        });

        list.appendChild(row);
      });
    }

    function renderCalls(){
      const folder = getFolder(state.activeFolderId);
      $("activeFolderTitle").textContent = folder ? folder.name : "Folder";

      const list = $("callList");
      const q = searchText.trim().toLowerCase();

      let calls = state.calls
        .filter(c => c.folderId === state.activeFolderId)
        .filter(c => {
          if(!q) return true;
          const hay = `${c.customer||""} ${c.location||""} ${c.phone||""} ${c.tech||""}`.toLowerCase();
          return hay.includes(q);
        })
        .sort((a,b) => (b.updatedAt ?? b.createdAt) - (a.updatedAt ?? a.createdAt));

      if(calls.length === 0){
        list.innerHTML = `<div class="empty">No service calls here yet.</div>`;
        return;
      }

      list.innerHTML = "";
      calls.forEach(call => {
        const row = document.createElement("div");
        row.className = "call";

        const phoneClean = normalizePhone(call.phone);
        const phoneHtml = phoneClean
          ? `<a class="link" href="tel:${escapeHtml(phoneClean)}">${escapeHtml(call.phone)}</a>`
          : `<span class="muted">No phone</span>`;

        const scheduled = call.scheduledAt ? fmtWhen(call.scheduledAt) : "";

        row.innerHTML = `
          <div>${priorityPill(call.priority)}</div>

          <div class="nowrap">
            <div class="strong nowrap">${escapeHtml(call.customer || "Unnamed Customer")}</div>
            <div class="muted nowrap">${escapeHtml(call.location || "No location/notes")}</div>
          </div>

          <div class="nowrap colhide">
            ${phoneHtml}
            <div class="muted nowrap">${escapeHtml(call.tech || "No tech")}</div>
          </div>

          <div class="nowrap colhide">
            ${statusTag(call.status)}
            <div class="muted nowrap">${scheduled ? "ðŸ“… " + escapeHtml(scheduled) : "No schedule"}</div>
          </div>

          <div class="muted nowrap colhide">
            Updated: ${fmtWhen(call.updatedAt || call.createdAt)}
          </div>

          <div class="links">
            <span class="link" data-action="edit">Edit</span>
            <span class="link" data-action="complete">Complete</span>
          </div>
        `;

        row.querySelector('[data-action="edit"]').addEventListener("click", () => openEditDrawer(call.id));
        row.querySelector('[data-action="complete"]').addEventListener("click", () => completeCall(call.id));

        list.appendChild(row);
      });
    }

    /** ---------------- Folder Modal (real form) ---------------- */
    function showFolderModal(){
      $("folderModal").classList.add("show");
      $("folderModal").setAttribute("aria-hidden", "false");
      showBackdrop();
      setTimeout(() => $("fm_name").focus(), 0);
    }

    function hideFolderModal(){
      $("folderModal").classList.remove("show");
      $("folderModal").setAttribute("aria-hidden", "true");
      folderModalMode = "new";
      editingFolderId = null;
      $("fm_name").value = "";
      $("btnDeleteFolder").style.display = "none";
      hideBackdropIfNone();
    }

    function openFolderModalNew(){
      folderModalMode = "new";
      editingFolderId = null;

      $("folderModalTitle").textContent = "New Folder";
      $("folderModalSubtitle").textContent = "Create a department like Grain, Irrigation, etc.";
      $("folderModalHelper").textContent = "Tip: Keep folder names short and consistent.";
      $("fm_name").value = "";
      $("btnDeleteFolder").style.display = "none";

      showFolderModal();
    }

    function openFolderModalRename(folderId){
      const folder = getFolder(folderId);
      if(!folder || folder.locked) return;

      folderModalMode = "rename";
      editingFolderId = folderId;

      $("folderModalTitle").textContent = "Folder Options";
      $("folderModalSubtitle").textContent = "Rename the folder, or delete it (calls will move to Completed).";
      $("folderModalHelper").textContent = `Current folder: ${folder.name}`;
      $("fm_name").value = folder.name;
      $("btnDeleteFolder").style.display = "inline-flex";

      showFolderModal();
    }

    function saveFolderFromModal(){
      const name = $("fm_name").value.trim();
      if(!name){
        alert("Folder name is required.");
        $("fm_name").focus();
        return;
      }

      // prevent duplicate names (case-insensitive)
      const dup = state.folders.some(f =>
        f.name.toLowerCase() === name.toLowerCase() &&
        (folderModalMode !== "rename" || f.id !== editingFolderId)
      );
      if(dup){
        alert("That folder name already exists.");
        $("fm_name").focus();
        return;
      }

      if(folderModalMode === "new"){
        const id = uid("f");
        const completed = state.folders.find(f => f.id === "f_completed");
        state.folders = state.folders.filter(f => f.id !== "f_completed");
        state.folders.push({ id, name });
        state.folders.push(completed);

        state.activeFolderId = id;
        saveState();
        render();
        hideFolderModal();
        return;
      }

      // rename
      const folder = getFolder(editingFolderId);
      if(!folder || folder.locked) return;

      folder.name = name;
      saveState();
      render();
      hideFolderModal();

      // keep drawer folder label accurate if drawer is open
      if($("drawer").classList.contains("show") && drawerMode === "new") setDrawerHeader();
    }

    function deleteFolderFromModal(){
      const folder = getFolder(editingFolderId);
      if(!folder || folder.locked) return;

      const count = folderCallCount(folder.id);
      const ok = confirm(`Delete "${folder.name}"?\n\n${count} calls will be moved to Completed.`);
      if(!ok) return;

      // move calls
      state.calls.forEach(c => {
        if(c.folderId === folder.id) c.folderId = "f_completed";
      });

      // remove folder
      state.folders = state.folders.filter(f => f.id !== folder.id);

      // fix active folder
      if(state.activeFolderId === folder.id) state.activeFolderId = "f_completed";

      saveState();
      render();
      hideFolderModal();

      if($("drawer").classList.contains("show") && drawerMode === "new") setDrawerHeader();
    }

    /** ---------------- Drawer (service calls) ---------------- */
    function showDrawer(){
      $("drawer").classList.add("show");
      $("drawer").setAttribute("aria-hidden", "false");
      showBackdrop();
    }

    function hideDrawer(){
      $("drawer").classList.remove("show");
      $("drawer").setAttribute("aria-hidden", "true");
      editingCallId = null;
      drawerMode = "new";
      $("btnDeleteCall").style.display = "none";
      hideBackdropIfNone();
    }

    function setDrawerHeader(){
      const folder = getFolder(getTargetFolderIdForNew());
      const folderName = folder ? folder.name : "Folder";
      $("f_folder").value = folderName;

      if(drawerMode === "new"){
        $("drawerTitle").textContent = "New Service Call";
        $("drawerSubtitle").textContent = `Adding into "${folderName}".`;
      }else{
        $("drawerTitle").textContent = "Edit Service Call";
        $("drawerSubtitle").textContent = `Editing call in "${folderName}".`;
      }
    }

    function resetForm(){
      $("f_customer").value = "";
      $("f_phone").value = "";
      $("f_tech").value = "";
      $("f_location").value = "";
      $("f_details").value = "";
      $("f_priority").value = "Medium";
      $("f_status").value = "New";
      $("f_scheduled").value = "";
    }

    function focusFirstField(){
      setTimeout(() => $("f_customer").focus(), 0);
    }

    function getTargetFolderIdForNew(){
      if(state.activeFolderId === "f_completed"){
        return state.folders.find(f => f.id !== "f_completed")?.id || "f_completed";
      }
      return state.activeFolderId;
    }

    function openNewDrawer(){
      // close folder modal if open
      if($("folderModal").classList.contains("show")) hideFolderModal();

      drawerMode = "new";
      editingCallId = null;
      $("btnDeleteCall").style.display = "none";
      resetForm();
      setDrawerHeader();
      showDrawer();
      focusFirstField();
    }

    function toDatetimeLocal(date){
      const pad = (n) => String(n).padStart(2, "0");
      const yyyy = date.getFullYear();
      const mm = pad(date.getMonth()+1);
      const dd = pad(date.getDate());
      const hh = pad(date.getHours());
      const mi = pad(date.getMinutes());
      return `${yyyy}-${mm}-${dd}T${hh}:${mi}`;
    }

    function parseDatetimeLocal(value){
      const v = String(value || "").trim();
      if(!v) return null;
      const d = new Date(v);
      if(Number.isNaN(d.getTime())) return null;
      return d.getTime();
    }

    function openEditDrawer(callId){
      // close folder modal if open
      if($("folderModal").classList.contains("show")) hideFolderModal();

      const call = state.calls.find(c => c.id === callId);
      if(!call) return;

      drawerMode = "edit";
      editingCallId = callId;
      $("btnDeleteCall").style.display = "inline-flex";

      const folder = getFolder(call.folderId);
      $("f_folder").value = folder ? folder.name : "";

      $("drawerTitle").textContent = "Edit Service Call";
      $("drawerSubtitle").textContent = `Editing call in "${folder ? folder.name : "Folder"}".`;

      $("f_customer").value = call.customer || "";
      $("f_phone").value = call.phone || "";
      $("f_tech").value = call.tech || "";
      $("f_location").value = call.location || "";
      $("f_details").value = call.details || "";
      $("f_priority").value = call.priority || "Medium";
      $("f_status").value = call.status || "New";

      if(call.scheduledAt){
        const d = new Date(call.scheduledAt);
        $("f_scheduled").value = Number.isNaN(d.getTime()) ? "" : toDatetimeLocal(d);
      }else{
        $("f_scheduled").value = "";
      }

      showDrawer();
      focusFirstField();
    }

    function saveFromForm(){
      const customer = $("f_customer").value.trim();
      if(!customer){
        alert("Customer name is required.");
        $("f_customer").focus();
        return;
      }

      const now = Date.now();
      const payload = {
        customer,
        phone: $("f_phone").value.trim(),
        tech: $("f_tech").value.trim(),
        location: $("f_location").value.trim(),
        details: $("f_details").value.trim(),
        priority: $("f_priority").value,
        status: $("f_status").value,
        scheduledAt: parseDatetimeLocal($("f_scheduled").value),
        updatedAt: now
      };

      if(drawerMode === "new"){
        const folderId = getTargetFolderIdForNew();
        const call = { id: uid("c"), folderId, ...payload, createdAt: now };

        if(call.status === "Completed") call.folderId = "f_completed";

        state.calls.unshift(call);
        saveState();
        render();
        hideDrawer();
      }else{
        const call = state.calls.find(c => c.id === editingCallId);
        if(!call) return;

        Object.assign(call, payload);
        if(call.status === "Completed") call.folderId = "f_completed";

        saveState();
        render();
        hideDrawer();
      }
    }

    function deleteCurrentCall(){
      if(!editingCallId) return;
      const call = state.calls.find(c => c.id === editingCallId);
      if(!call) return;

      const ok = confirm(`Delete "${call.customer}"? This cannot be undone.`);
      if(!ok) return;

      state.calls = state.calls.filter(c => c.id !== editingCallId);
      saveState();
      render();
      hideDrawer();
    }

    function completeCall(callId){
      const call = state.calls.find(c => c.id === callId);
      if(!call) return;

      const ok = confirm(`Mark "${call.customer}" as completed?\nIt will move to Completed.`);
      if(!ok) return;

      call.status = "Completed";
      call.folderId = "f_completed";
      call.updatedAt = Date.now();

      saveState();
      render();
    }

    /** ---------------- Wiring ---------------- */
    $("btnNewFolder").addEventListener("click", () => {
      // close drawer if open? (optional). We'll leave drawer open; modal sits over it.
      openFolderModalNew();
    });

    $("btnNewCall").addEventListener("click", openNewDrawer);

    $("searchBox").addEventListener("input", (e) => {
      searchText = e.target.value || "";
      renderCalls();
    });

    // Backdrop: close topmost overlay
    $("backdrop").addEventListener("click", () => {
      // prefer closing modal first
      if($("folderModal").classList.contains("show")) { hideFolderModal(); return; }
      if($("drawer").classList.contains("show")) { hideDrawer(); return; }
    });

    // Folder modal buttons
    $("btnCloseFolderModal").addEventListener("click", hideFolderModal);
    $("btnCancelFolderModal").addEventListener("click", hideFolderModal);
    $("btnSaveFolderModal").addEventListener("click", saveFolderFromModal);
    $("btnDeleteFolder").addEventListener("click", deleteFolderFromModal);

    // Drawer buttons
    $("btnCloseDrawer").addEventListener("click", hideDrawer);
    $("btnCancel").addEventListener("click", hideDrawer);
    $("btnSave").addEventListener("click", saveFromForm);
    $("btnDeleteCall").addEventListener("click", deleteCurrentCall);

    // Keyboard shortcuts
    window.addEventListener("keydown", (e) => {
      const isTyping = e.target && (e.target.tagName === "INPUT" || e.target.tagName === "TEXTAREA" || e.target.tagName === "SELECT");
      const drawerOpen = $("drawer").classList.contains("show");
      const modalOpen = $("folderModal").classList.contains("show");

      // Ctrl+Enter save (drawer or folder modal)
      if(e.ctrlKey && e.key === "Enter"){
        if(modalOpen){ e.preventDefault(); saveFolderFromModal(); return; }
        if(drawerOpen){ e.preventDefault(); saveFromForm(); return; }
      }

      if(e.key === "Escape"){
        if(modalOpen){ e.preventDefault(); hideFolderModal(); return; }
        if(drawerOpen){ e.preventDefault(); hideDrawer(); return; }

        // clear search
        $("searchBox").value = "";
        searchText = "";
        renderCalls();
      }

      if(!drawerOpen && !modalOpen && !isTyping){
        if(e.key.toLowerCase() === "n"){
          openNewDrawer();
        }
        if(e.key === "/"){
          e.preventDefault();
          $("searchBox").focus();
        }
      }
    });

    // Enter key in folder name field saves
    $("fm_name").addEventListener("keydown", (e) => {
      if(e.key === "Enter"){
        e.preventDefault();
        saveFolderFromModal();
      }
    });

    // Initial render
    render();
  </script>
</body>
</html>
